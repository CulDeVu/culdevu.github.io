<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Fluid dynamics update</title>
  <meta name="description" content="[sort description and key words to shove in meta tags]
">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="http://yourdomain.com/blog/2015/fluid-dyanamic-update/">
  <link rel="alternate" type="application/rss+xml" title="CulDeVu" href="http://yourdomain.com/feed.xml">
</head>


  <body>
  
    <!-- <span class="sidebar">
        hey there
    </span> -->
    <span class="sidebar-color">
    </span>
    
    <span class="content">
        
        <span class="sidebar-content">
            <span class="site-title">
    CulDeVu
</span>

<a class="nav-button" href="/">
    Home
</a>

    

    
        <a class="nav-button" href=" /portfolio/ ">
            Portfolio
        </a>
    

    
        <a class="nav-button" href=" /resume/ ">
            Resume
        </a>
    

    
        <a class="nav-button" href=" /about/ ">
            About
        </a>
    

    

    
        <a class="nav-button" href=" /about/ ">
            Posts
        </a>
    

    


<p>
    <a href="https://github.com/culdevu">
        <span class="social-media-container"><svg width="100%" height="100%" viewBox="0 0 16 16"><path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/></svg>
</span>
    </a>
    <a href="https://twitter.com/culdevu">
        <span class="social-media-container"><svg viewBox="0 0 16 16"><path fill="#828282" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/></svg>
</span>
    </a>
    <a href="/feed.xml">
        <span class="social-media-container"><svg height="56.693px" id="Layer_1" version="1.1" viewBox="0 0 56.693 56.693" width="56.693px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M3.428,31.085c6.19,0,12.009,2.418,16.382,6.816c4.381,4.398,6.793,10.256,6.793,16.492h9.539  c0-18.113-14.676-32.848-32.714-32.848V31.085z M3.443,14.174c22.061,0,40.01,18.047,40.01,40.231h9.539  c0-27.445-22.229-49.77-49.549-49.77V14.174z M16.634,47.741c0,3.648-2.959,6.607-6.607,6.607S3.42,51.39,3.42,47.741  c0-3.65,2.958-6.607,6.606-6.607S16.634,44.091,16.634,47.741z"/></svg></span>
    </a>
</p>

<hr />
<br />

<p>
    <h2>Hello there!</h2>
    <p>
        [insert short description about me and what i do. make sure 
        that it's conveyed that this is a personal site and i'm available for 
        hire whenever someone shows an interest]
    </p>
</p>

<hr />
<br />

<p>
    maybe have a thingy where i'm like "look at all my old posts and shit!"
    or maybe have one of those "sort posts by catagory" things that are all the rage
</p>

        </span>
        
        <span class="content-wrapper">
            <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">Fluid dynamics update</h1>
    <p class="post-meta"><time datetime="2015-09-29T00:00:00-07:00" itemprop="datePublished">Sep 29, 2015</time></p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <p>I’m not really going to talk about much math-y stuff this time. I’ve covered too much ground since my last entry ( Posted Image ) to be able to remember all the pitfalls I ran into. So this time I’m only really going to be talking about the general algorithm, how I deal with the pitfalls of the marker particle method, and the ongoing translation to CUDA. And probably share some of my Mario Maker levels. I’m addicted to stars Posted Image</p>

<p>So! Let’s do this!</p>

<p>[media]https://www.youtube.com/watch?v=0xBAqjxHUkA[/media]</p>

<p>Sorry for the video being kinda shaky. OBS is having a hard time capturing details and YouTube thinks everything ever is a camcorder, so it looks a little strange. It get’s across the idea, though. Note that there is still no surface tension, which would account for just about everything else strange looking with the simulation.</p>

<p>The General Algorithm</p>

<p>So the algorithm for simulating a Eulerian fluid goes as follows:</p>

<pre><code>init particles
init velocity field, type field, etc

for each frame:
    apply external forces to velocity field
    
    clear type field
    update particle positions and apply to type field
    extrapolate the velocity field
    
    find particles to re-position
    re-position those particles
    
    build pressure matrices
    solve the pressure equation
    apply the pressure to the velocity field
    
    enforce boundary conditions
    
    advect the velocity field
</code></pre>

<p>The velocity field is the standard MAC staggered grid, cause why not, and because it’s useful for pressure computation and velocity extrapolation. The extrapolation and pressure step are straight out of academic papers so it’s standard stuff.</p>

<p>The marker particles are the part I don’t really know about. I just advect the marker particles through the velocity field just like anything else, and wherever the marker particles end up defines where the fluid exists or doesn’t. This is pretty much the simplest method of defining the interior vs exterior of a fluid, so it has a lot of pitfalls, but I’ll get to those in a minute. The issue is, though, that most everyone doesn’t talk about this method (because of the many many issues it has) and so they use something called level sets. I’ve tried implementing level sets several times, and marker particles are just so much simpler in every way.</p>

<h1 id="marker-particles">Marker Particles</h1>

<p>So the biggest pitfall about marker particles is that, due to numerical inaccuracy and a bunch of other issues, they tend to bunch up a lot in certain places. Namely, places where the divergence of the velocity field is still positive even after the incompressibility pressure solver. You’d think that, since the pressure is positive in some places, it’d be negative in the same area, cancelling each other out, but it’s not. The fact that gravity is always pulling down on the fluid makes it not always true, so what ends up happening is a net loss of volume from full to nearly 0 in a couple minutes.</p>

<p>So what I tried to do, instead of using level sets like a sane person, I decided to force the fluid to conserve volume. The way I did this is pretty straightforward, and is the “find/re-position particles” part of the above algorithm. Basically,</p>

<ol>
  <li>iterate over every particle over a grid and see if there are already more than a certain number of particles (max density, if you will) in that grid cell. If there are, I mark it to be re-positioned</li>
  <li>iterate over every grid cell where and see if there are less than some other number of particles (min density), and if there are, start pulling from the re-position pool and fill in those spots</li>
</ol>

<p>This is rather finicky in practice. For example, if I set minDensity to maxDensity, you see a lot of artifacts from there not being enough particles in the re-position pool to accommodate (because of the overall positive divergence I mentioned). A happy median, I found, was setting maxDensity to anywhere between 2 or 3 times the minDensity. Sure, this DOES lead to volume loss by a factor of whatever multiple you choose, but it’s much better than having visually disgusting and simulations.</p>

<p>[attachment=29248:lolp.jpg]</p>

<p>To be fair, the simulation without re-position looks a lot more fluid and water-like. However, conserving volume it too important to be avoided. Oh well.</p>

<h1 id="cuda">CUDA</h1>

<p>I’ve been translating small pieces of the simulation to use the GPGPU via CUDA. I’ve gotten the “update particle” portion completely ported to the GPU, which is just a simple advection and setting type fields. The really neat one is the pressure solver.</p>

<p>In order to find the pressure in each cell, long story short, you need to construct a matrix something like this:
[attachment=29249:matrix.jpg]
, and then solve for pressure. On the cpu I used Gauss-Seidel to solve it, but I have no idea how to do it on the GPU. Luckily, there’s a library called cusp that implemented everything for me!</p>

<pre><code>struct cuspTriple
{
	int row, col;
	float amount;
};
cusp::array1d&lt;float, cusp::host_memory&gt; pressure(mapW * mapH);
void project()
{
	cusp::array1d&lt;float, cusp::host_memory&gt; b(mapW * mapH);
	{
		float scale = rho / dt;
		for (int y = 0; y &lt; mapH; ++y)
		{
			for (int x = 0; x &lt; mapW; ++x)
			{
				int index = y * mapW + x;
				b[index] = scale * (u-&gt;at(x + 1, y) - u-&gt;at(x, y) +
					v-&gt;at(x, y + 1) - v-&gt;at(x, y));
			}
		}
	}

	vector&lt;cuspTriple&gt; data;
	{
		for (int y = 0; y &lt; mapH; ++y)
		{
			for (int x = 0; x &lt; mapW; ++x)
			{
				float scale = 1;
				int n = 0;

				if (x &gt; 0) 
				{
					if (type[y * mapW + x - 1] != SOLID)
					{
						if (type[y * mapW + x - 1] == WATER)
						{
							cuspTriple t;
							t.row = y * mapW + x;
							t.col = y * mapW + x - 1;
							t.amount = 1;
							data.push_back(t);
						}
						++n;
					}
				}
				if (y &gt; 0) {
					if (type[(y - 1) * mapW + x] != SOLID)
					{
						if (type[(y - 1) * mapW + x] == WATER)
						{
							cuspTriple t;
							t.row = y * mapW + x;
							t.col = (y - 1) * mapW + x;
							t.amount = 1;
							data.push_back(t);
						}
						++n;
					}
				}
				if (x &lt; mapW - 1) {
					if (type[y * mapW + x + 1] != SOLID)
					{
						if (type[y * mapW + x + 1] == WATER)
						{
							cuspTriple t;
							t.row = y * mapW + x;
							t.col = y * mapW + x + 1;
							t.amount = 1;
							data.push_back(t);
						}
						++n;
					}
				}
				if (y &lt; mapH - 1) {
					if (type[(y + 1) * mapW + x] != SOLID)
					{
						if (type[(y + 1) * mapW + x] == WATER)
						{
							cuspTriple t;
							t.row = y * mapW + x;
							t.col = (y + 1) * mapW + x;
							t.amount = 1;
							data.push_back(t);
						}
						++n;
					}
				}

				cuspTriple t;
				t.row = y * mapW + x;
				t.col = y * mapW + x;
				t.amount = -n;
				data.push_back(t);
			}
		}

	}
	cusp::coo_matrix&lt;int, float, cusp::host_memory&gt; A(mapW * mapH, mapW * mapH, data.size());
	{
		for (int i = 0; i &lt; data.size(); ++i)
		{
			A.row_indices[i] = data[i].row;
			A.column_indices[i] = data[i].col;
			A.values[i] = data[i].amount;
		}
	}

	cusp::default_monitor&lt;float&gt; monitor(b, 600, 0.01, 0);
	cusp::precond::diagonal&lt;float, cusp::host_memory&gt; M(A);

	cusp::krylov::cg(A, pressure, b, monitor, M);
}
void applyPressure()
{
	float scale = dt / (rho);

	for (int y = 0; y &lt; mapH; y++)
	{
		for (int x = 0; x &lt; mapW; x++)
		{
			if (type[y * mapW + x] != WATER)
				continue;

			float p = pressure[y * mapW + x];

			u-&gt;at(x, y) -= scale * p;
			u-&gt;at(x + 1, y) += scale * p;
			v-&gt;at(x, y) -= scale * p;
			v-&gt;at(x, y + 1) += scale * p;
		}
	}
}
</code></pre>

<p>This is the version of the GPU solver I have right now. It has a ton of theoretical std::vector overhead (idk how well the CUDA compiler does to try to optimize things out), so the next thing I’m going to be testing is whether or not over-approximating the number of non-zero elements in the sparse matrix will still be efficient.</p>

<p>Also, the GPU version is around 3-4 times faster than the CPU version! Now, on the other hand, it’s only 3 or 4 times faster than the CPU version. That’s with copying data back and forth from the GPU, so I give it a little bit of a break, but not much. I’m extremely confident that I could easily squeeze much more efficiency out of it, so that will have to be something I’ll deal with at a later date, after I port a bit more to the GPU.</p>

<p>In short, kill me now.</p>

<p>Conclusion</p>

<p>Could someone please give me stars in Super Mario Maker? I’m addicted and I need all you have. One of my levels’ ID is 04B7-0000-0069-DB69 and from there you should be able to access the 3 levels I’ve uploaded. They have &lt; 20% clear rate on each of them for some strange reason, even though I think they’re pretty easy (and fun).</p>

<p>Anyway, thanks for reading!</p>

  </div>

</article>

        </span>

    </span>

    <!-- <footer class="site-footer">

  <div class="wrapper">
  
    <div>
        Copyright © 2015 CulDeVu
    </div>
    
    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li>CulDeVu</li>
          <li><a href="mailto:culdevu@gmail.com">culdevu@gmail.com</a></li>
        </ul>
      </div>

      <div class="footer-col footer-col-2">
        <ul class="social-media-list">
          
          <li>
            Include file 'icon-github.html username=site.github_username' contains invalid characters or sequences
          </li>
          

          
          <li>
            Include file 'icon-twitter.html username=site.twitter_username' contains invalid characters or sequences
          </li>
          
        </ul>
      </div>

      <div class="footer-col footer-col-3">
        <p>[sort description and key words to shove in meta tags]
</p>
      </div>
    </div>

  </div>

</footer>
 -->

  </body>

</html>
